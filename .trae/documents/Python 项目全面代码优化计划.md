# Python 项目代码优化计划

## 📊 项目概况
- **项目类型**: 知识图谱构建系统（基于 LlamaIndex + Neo4j）
- **核心功能**: 文档处理、实体提取、关系抽取、图谱构建
- **代码规模**: 约 20+ 核心模块文件
- **主要问题**: 代码重复、模块耦合、缺乏统一工具库、测试覆盖不足

## 🎯 优化目标

### 1. 代码去重与重构
- **合并重复的 JSON 解析逻辑**（3处重复）
- **统一文本清理功能**（分散在多个文件）
- **整合配置管理**（避免重复配置）
- **消除循环导入风险**

### 2. 创建可复用工具库
- **创建 `llama/common/text_utils.py`** - 统一文本处理
- **创建 `llama/common/json_utils.py`** - 统一 JSON 解析
- **创建 `llama/common/file_utils.py`** - 文件操作工具
- **创建 `llama/common/cache_utils.py`** - 缓存管理工具

### 3. 性能优化
- **优化 LLM 缓存机制**（改进 LRU 策略）
- **优化并发处理**（动态调整线程池）
- **优化内存使用**（减少不必要的对象创建）
- **优化数据库查询**（批量操作替代循环）

### 4. 代码质量提升
- **添加完整的类型注解**
- **改进异常处理**
- **统一日志格式**
- **添加代码文档**

### 5. 测试优化
- **删除过时的测试代码**（如 `verify_refactor.py`）
- **添加单元测试覆盖**（核心模块）
- **添加集成测试**（端到端流程）
- **优化测试执行速度**

## 📋 具体优化步骤

### 阶段 1: 代码分析与去重
1. 分析并合并重复的 JSON 解析函数
2. 统一文本清理逻辑到单一模块
3. 整合配置管理，消除重复
4. 重构循环导入问题

### 阶段 2: 创建工具库
1. 创建 `common/` 目录结构
2. 实现 `text_utils.py`（文本清理、格式化）
3. 实现 `json_utils.py`（安全解析、错误修复）
4. 实现 `file_utils.py`（文件操作、类型检测）
5. 实现 `cache_utils.py`（LRU 缓存、持久化）

### 阶段 3: 性能优化
1. 优化 LLM 缓存策略（改进命中率）
2. 优化并发处理（动态线程池）
3. 优化内存使用（对象池、延迟加载）
4. 优化数据库操作（批量写入）

### 阶段 4: 代码质量提升
1. 添加类型注解到所有公共 API
2. 改进异常处理（具体化异常类型）
3. 统一日志格式（结构化日志）
4. 添加文档字符串（Google 风格）

### 阶段 5: 测试优化
1. 删除 `verify_refactor.py`（过时测试）
2. 保留并优化现有测试
3. 添加核心模块单元测试
4. 添加性能基准测试
5. 生成测试覆盖率报告

## 📈 预期效果

### 代码质量指标
- **代码重复率**: 从 ~15% 降至 <5%
- **圈复杂度**: 平均降低 30%
- **类型注解覆盖率**: 从 ~40% 提升至 >90%
- **测试覆盖率**: 从 ~20% 提升至 >70%

### 性能指标
- **LLM 调用缓存命中率**: 从 ~20% 提升至 >50%
- **文档处理速度**: 提升 20-30%
- **内存使用**: 降低 15-25%
- **并发处理效率**: 提升 40%

### 可维护性指标
- **模块耦合度**: 降低 40%
- **代码可读性**: 显著提升
- **新增功能开发时间**: 减少 30%

## ⚠️ 风险控制
- 所有改动保持向后兼容
- 分阶段实施，每阶段验证
- 保留原有功能测试
- 提供回滚方案

## 📝 交付物
1. 优化后的代码库
2. 优化前后对比报告
3. 性能基准测试结果
4. 测试覆盖率报告
5. 代码文档更新