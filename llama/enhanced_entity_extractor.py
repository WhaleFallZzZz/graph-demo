"""
Enhanced Entity Extractor with Standard Term Mapping
"""
import logging
from typing import Dict, Any, List

logger = logging.getLogger(__name__)

class StandardTermMapper:
    """标准术语映射器"""
    
    # 57个标准实体列表
    STANDARD_ENTITIES = {
        # 疾病(12)
        "近视", "远视", "散光", "弱视", "斜视", "病理性近视", "轴性近视", 
        "屈光不正", "屈光参差", "老视", "并发性白内障", "后巩膜葡萄肿",
        # 症状体征(13)
        "视物模糊", "眼胀", "虹视", "眼痛", "畏光", "流泪", "视力下降", 
        "豹纹状眼底", "视网膜萎缩", "脉络膜萎缩", "黄斑出血", "漆样裂纹", "视盘杯盘比(C/D)扩大",
        # 解剖结构(12)
        "角膜", "晶状体", "视网膜", "视神经", "黄斑区", "中心凹", 
        "睫状肌", "悬韧带", "脉络膜", "巩膜", "前房", "房水",
        # 检查参数(10)
        "眼轴长度", "屈光度", "远视储备", "调节幅度", "调节灵敏度", 
        "眼压", "角膜曲率", "调节滞后", "五分记录法", "LogMAR视力表",
        # 治疗防控(10)
        "户外活动", "角膜塑形镜(OK镜)", "低浓度阿托品", "RGP镜片", "后巩膜加固术", 
        "离焦框架镜", "视觉训练", "准分子激光手术(LASIK)", "全飞秒激光手术(SMILE)", "眼内接触镜植入(ICL)"
    }
    
    # 静态映射表
    SYNONYM_MAP = {
    # 眼轴长度相关 (扩展)
    "眼球长度": "眼轴长度", "AL": "眼轴长度", "轴长": "眼轴长度", "眼轴": "眼轴长度", "AL长度": "眼轴长度",
    "眼轴增长": "眼轴长度", "眼轴增长速率": "眼轴长度", "眼轴增长年率": "眼轴长度",
    "眼球轴长": "眼轴长度", "轴长度": "眼轴长度", "眼球AL": "眼轴长度",
    
    # 近视相关 (扩展)
    "近视眼": "近视", "近视症": "近视", "轴性近视眼": "轴性近视", "病理性近视眼": "病理性近视",
    "近视防控": "近视", "近视加深": "近视", "近视易感性": "近视", "近视发生与发展": "近视",
    "屈光性近视": "近视", "进行性近视": "近视", "高度近视": "近视",
    "近视进展加快": "近视", "假性近视向真性近视发展": "近视",
    
    # 远视相关
    "远视眼": "远视", "远视症": "远视",
    
    # 散光相关 (扩展)
    "散光眼": "散光", "散光轴位": "散光", "规则散光": "散光", "不规则散光": "散光",
    
    # 弱视相关 (扩展)
    "弱视眼": "弱视", "弱视症": "弱视",
    "屈光不正性弱视": "弱视", "屈光参差性弱视": "弱视", "形觉剥夺性弱视": "弱视",
    "弱视类型分类": "弱视", "屈光不正性弱视诊断标准": "弱视", "斜视性弱视": "弱视",
    
    # 斜视相关 (扩展)
    "斜视眼": "斜视", "斜视症": "斜视",
    "调节性内斜视": "斜视", "非调节性内斜视": "斜视", "间歇性外斜视": "斜视",
    
    # 屈光不正相关
    "屈光异常": "屈光不正", "屈光问题": "屈光不正",
    
    # 角膜塑形镜相关 (扩展)
    "OK镜": "角膜塑形镜(OK镜)", "角膜塑形镜": "角膜塑形镜(OK镜)", "塑形镜": "角膜塑形镜(OK镜)",
    "Ortho-K": "角膜塑形镜(OK镜)", "Orthokeratology": "角膜塑形镜(OK镜)",
    
    # 低浓度阿托品相关 (扩展)
    "低浓度阿托品眼药水": "低浓度阿托品", "阿托品": "低浓度阿托品",
    "Atropine": "低浓度阿托品", "阿托品滴眼液": "低浓度阿托品",
    "阿托品眼药水": "低浓度阿托品", "低浓度阿托品滴眼液": "低浓度阿托品",
    
    # 视觉训练相关 (扩展)
    "视功能训练": "视觉训练", "视觉功能训练": "视觉训练", "视训": "视觉训练",
    "立体视觉": "视觉训练", "双眼视觉系统": "视觉训练", "视觉发育关键期": "视觉训练",
    "视觉刺激疗法": "视觉训练", "视觉治疗": "视觉训练",
    
    # 眼压相关 (扩展)
    "眼内压": "眼压", "IOP": "眼压", "眼内压力": "眼压",
    
    # 屈光度相关 (扩展)
    "度数": "屈光度", "D": "屈光度", "球镜度数": "屈光度",
    "等效球镜": "屈光度", "SE": "屈光度", "Diopter": "屈光度",
    
    # 调节幅度相关 (扩展)
    "调节力": "调节幅度", "AMP": "调节幅度",
    "调节不足": "调节幅度", "调节功能": "调节幅度", "调节能力": "调节幅度",
    
    # 调节灵敏度相关 (扩展)
    "调节灵活度": "调节灵敏度", "Flipper": "调节灵敏度",
    "调节灵敏度下降": "调节灵敏度",
    
    # 调节滞后相关
    "调节滞后量": "调节滞后", "Lag": "调节滞后",
    
    # 角膜曲率相关 (扩展)
    "K值": "角膜曲率", "角膜K值": "角膜曲率", "Keratometry": "角膜曲率",
    
    # 视物模糊相关 (扩展)
    "视力模糊": "视物模糊", "看东西模糊": "视物模糊", "模糊": "视物模糊",
    "视物不清": "视物模糊", "视物不清晰": "视物模糊",
    
    # 视力下降相关 (扩展)
    "视力降低": "视力下降", "视力减退": "视力下降",
    "视疲劳": "视力下降", "12岁以后视力难以改善": "视力下降",
    
    # 眼痛相关
    "眼睛痛": "眼痛", "眼部疼痛": "眼痛",
    
    # 畏光相关 (扩展)
    "怕光": "畏光", "光敏感": "畏光", "光敏": "畏光", "对光敏感": "畏光",
    
    # 流泪相关
    "流眼泪": "流泪", "眼泪多": "流泪",
    
    # 眼胀相关 (扩展)
    "眼睛胀": "眼胀", "眼部胀痛": "眼胀", "眼球胀痛": "眼胀",
    "眼球胀痛,甚至恶心呕吐及神经官能症": "眼胀",
    
    # 解剖结构 - 视网膜相关 (扩展)
    "眼底": "视网膜", "视网膜层": "视网膜", "双眼视网膜像差异": "视网膜",
    
    # 解剖结构 - 视神经相关 (扩展)
    "视盘": "视神经", "视乳头": "视神经", "Optic Nerve": "视神经",
    
    # 解剖结构 - 黄斑区相关 (扩展)
    "黄斑": "黄斑区", "黄斑部": "黄斑区",
    "黄斑水肿": "黄斑区", "黄斑功能退化": "黄斑区",
    
    # 解剖结构 - 中心凹相关 (扩展)
    "中央凹": "中心凹", "黄斑中心凹": "中心凹",
    "黄斑中心凹功能正常": "中心凹",
    
    # 解剖结构 - 睫状肌相关
    "睫状体": "睫状肌",
    
    # 解剖结构 - 晶状体相关 (扩展)
    "晶状体变凸": "晶状体", "晶状体屈光力": "晶状体",
    
    # 解剖结构 - 脉络膜相关
    "脉络膜层": "脉络膜",
    
    # 解剖结构 - 巩膜相关
    "巩膜层": "巩膜", "白眼球": "巩膜",
    
    # 解剖结构 - 前房相关
    "前房角": "前房",
    
    # 解剖结构 - 房水相关
    "眼房水": "房水", "前房水": "房水",
    
    # 治疗防控 - 户外活动相关
    "户外运动": "户外活动", "室外活动": "户外活动",
    
    # 治疗防控 - RGP镜片相关
    "RGP": "RGP镜片", "硬性隐形眼镜": "RGP镜片", "硬性接触镜": "RGP镜片",
    "硬性角膜接触镜": "RGP镜片", "硬性透氧性角膜接触镜": "RGP镜片",
    
    # 治疗防控 - 后巩膜加固术相关
    "后巩膜加固": "后巩膜加固术", "后巩膜手术": "后巩膜加固术",
    
    # 治疗防控 - 离焦框架镜相关 (扩展)
    "离焦眼镜": "离焦框架镜", "离焦镜片": "离焦框架镜", "离焦镜": "离焦框架镜",
    "离焦型眼镜": "离焦框架镜",
    
    # 治疗防控 - 准分子激光手术相关 (扩展)
    "LASIK手术": "准分子激光手术(LASIK)", "LASIK": "准分子激光手术(LASIK)",
    "准分子手术": "准分子激光手术(LASIK)",
    
    # 治疗防控 - 全飞秒激光手术相关 (扩展)
    "SMILE手术": "全飞秒激光手术(SMILE)", "SMILE": "全飞秒激光手术(SMILE)",
    "全飞秒手术": "全飞秒激光手术(SMILE)",
    
    # 治疗防控 - 眼内接触镜植入相关 (扩展)
    "ICL手术": "眼内接触镜植入(ICL)", "ICL": "眼内接触镜植入(ICL)",
    "眼内镜": "眼内接触镜植入(ICL)", "眼内接触镜": "眼内接触镜植入(ICL)",
    
    # 检查参数 - 远视储备相关 (扩展)
    "远视储备值": "远视储备", "远储": "远视储备", "远视储备消耗": "远视储备",
    
    # 检查参数 - 五分记录法相关
    "5分记录法": "五分记录法", "五分制": "五分记录法",
    
    # 检查参数 - LogMAR视力表相关 (扩展)
    "LogMAR": "LogMAR视力表", "LogMAR表": "LogMAR视力表",
    "国际通用视力表": "LogMAR视力表", "国际通用视力评估标准": "LogMAR视力表",
}
    
    @classmethod
    def standardize(cls, entity_name: str) -> str:
        """
        标准化实体名称
        """
        if not entity_name:
            return entity_name
            
        # 1. 基础清理
        clean_name = entity_name.strip()
        
        # 2. 查表映射
        if clean_name in cls.SYNONYM_MAP:
            standard_name = cls.SYNONYM_MAP[clean_name]
            logger.debug(f"术语标准化: '{clean_name}' -> '{standard_name}'")
            return standard_name
            
        return clean_name

    @classmethod
    def validate_batch(cls, triplets: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
        """
        批量验证三元组有效性
        """
        valid_triplets = []
        # 批量检查逻辑
        for triplet in triplets:
            head = triplet.get("head")
            tail = triplet.get("tail")
            relation = triplet.get("relation")
            
            # 1. 基础完整性检查
            if not (head and tail and relation):
                continue
                
            # 2. 避免自环
            if head == tail:
                continue
                
            # 3. 实体类型检查 (如果开启了严格模式)
            # 这里我们执行"软验证"，只标记不过滤，或者根据置信度过滤
            # 为了满足用户"验证"的需求，我们确保实体不是纯数字或特殊符号
            if not cls._is_valid_entity(head) or not cls._is_valid_entity(tail):
                continue
                
            valid_triplets.append(triplet)
        return valid_triplets

    @classmethod
    def _is_valid_entity(cls, text: str) -> bool:
        if not text or len(text) < 1:
            return False
        # 过滤纯数字
        if text.replace(".", "").isdigit():
            return False
        # 过滤纯标点
        if all(char in ",./<>?;':\"[]\\{}|`~!@#$%^&*()-_=+" for char in text):
            return False
        return True

    @classmethod
    def process_triplets(cls, triplets: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
        """
        批量处理三元组，标准化其中的实体并进行批量验证
        """
        processed_triplets = []
        for triplet in triplets:
            head = triplet.get("head")
            tail = triplet.get("tail")
            
            # 标准化
            std_head = cls.standardize(head)
            std_tail = cls.standardize(tail)
            
            # 记录变化
            if std_head != head:
                triplet["original_head"] = head
                triplet["head"] = std_head
            
            if std_tail != tail:
                triplet["original_tail"] = tail
                triplet["tail"] = std_tail
            
            processed_triplets.append(triplet)
        
        # 执行批量验证
        return cls.validate_batch(processed_triplets)
